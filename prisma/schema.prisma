// Prisma Schema für BdP Abrechnungssystem
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Benutzer für Admin-Zugriff
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  password  String   // bcrypt hash
  role      String   @default("admin") // admin, landeskasse
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Aktionen (Maßnahmen/Events)
model Aktion {
  id           String        @id @default(cuid())
  titel        String
  startdatum   DateTime
  enddatum     DateTime
  status       String        @default("aktiv") // aktiv, inaktiv, abgeschlossen
  beschreibung String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  abrechnungen Abrechnung[]
}

// Kategorien für Abrechnungen
model Kategorie {
  id           String       @id @default(cuid())
  name         String       @unique
  beschreibung String?
  sortierung   Int          @default(0)
  aktiv        Boolean      @default(true)
  abrechnungen Abrechnung[]
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
}

// Haupttabelle: Abrechnungsposten
model Abrechnung {
  id                String    @id @default(cuid())
  
  // Persönliche Daten
  name              String
  stamm             String
  email             String
  
  // Referenzen
  aktionId          String
  aktion            Aktion    @relation(fields: [aktionId], references: [id], onDelete: Cascade)
  kategorieId       String
  kategorie         Kategorie @relation(fields: [kategorieId], references: [id])
  
  // Belegdaten
  belegbeschreibung String?
  belegdatum        DateTime
  betrag            Float
  belegUrl          String?   // URL zum hochgeladenen Beleg
  belegDateiname    String?
  
  // Fahrtkosten-spezifisch (optional)
  fahrzeugtyp       String?   // PKW, Motorrad, etc.
  kilometer         Float?
  kmSatz            Float?    // 0.10 - 0.50 EUR
  mitfahrer         Int?
  lagerleitung      Boolean   @default(false) // +0.05 EUR
  material          Boolean   @default(false) // +0.05 EUR
  anhaenger         Boolean   @default(false) // +0.05 EUR
  
  // Status und Metadaten
  status            String    @default("entwurf") // entwurf, eingereicht, versendet
  notizen           String?
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([aktionId])
  @@index([kategorieId])
  @@index([status])
}

// Protokollierung von PDF-Exporten und E-Mail-Versand
model Export {
  id            String   @id @default(cuid())
  aktionId      String
  aktionTitel   String
  dateiname     String
  dateipfad     String
  anzahlPosten  Int
  gesamtsumme   Float
  emailVersendet Boolean @default(false)
  emailAn       String?
  versandtAm    DateTime?
  createdAt     DateTime @default(now())
  
  @@index([aktionId])
}
