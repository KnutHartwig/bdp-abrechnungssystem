// Prisma Schema für BdP Abrechnungssystem
// Version: 2.0 - Next.js 15 Edition

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User-Management für Admin-Bereiche
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  password  String
  role      UserRole @default(ADMIN)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

enum UserRole {
  ADMIN
  LANDESKASSE
  SUPER_ADMIN
}

// Aktionsverwaltung
model Aktion {
  id           String        @id @default(cuid())
  titel        String
  beschreibung String?       // NEU: Optionale Beschreibung der Aktion
  startdatum   DateTime
  enddatum     DateTime
  status       AktionStatus  @default(AKTIV)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  abrechnungen Abrechnung[]

  @@map("aktionen")
}

enum AktionStatus {
  AKTIV
  INAKTIV
  ABGESCHLOSSEN
}

// Zentrale Abrechnungstabelle
model Abrechnung {
  id                String    @id @default(cuid())
  
  // Personen-Daten
  name              String
  stamm             String
  email             String
  
  // Aktion-Referenz
  aktionId          String
  aktion            Aktion    @relation(fields: [aktionId], references: [id], onDelete: Cascade)
  
  // Kategorie (basierend auf Excel-Arbeitsblättern)
  kategorie         Kategorie
  
  // Beleg-Informationen
  belegbeschreibung String?
  belegdatum        DateTime
  betrag            Decimal   @db.Decimal(10, 2)
  belegUrl          String?
  
  // Fahrtkosten-spezifische Felder (optional)
  kilometer         Int?      // GEÄNDERT: von kilometerstand zu kilometer
  fahrzeugtyp       Fahrzeugtyp?
  kmSatz            Decimal?  @db.Decimal(4, 2) // NEU: Kilometer-Satz (z.B. 0.30, 0.40, 0.50)
  mitfahrer         Int?      @default(0)
  zuschlagLagerleitung Boolean @default(false)
  zuschlagMaterial  Boolean   @default(false)
  zuschlagAnhaenger Boolean   @default(false)
  
  // Status und Metadaten
  status            AbrechnungStatus @default(ENTWURF)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([aktionId])
  @@index([status])
  @@map("abrechnungen")
}

// 11 Kategorien aus Excel-Vorlage
enum Kategorie {
  TEILNAHMEBEITRAEGE
  FAHRTKOSTEN
  UNTERKUNFT
  VERPFLEGUNG
  MATERIAL
  PORTO
  TELEKOMMUNIKATION
  VERSICHERUNG
  HONORARE
  OFFENTLICHKEITSARBEIT
  SONSTIGE_AUSGABEN
}

enum Fahrzeugtyp {
  PKW              // 0.30 EUR/km
  TRANSPORTER      // 0.40 EUR/km
  BUS              // 0.50 EUR/km
}

enum AbrechnungStatus {
  ENTWURF
  EINGEREICHT
  GEPRUEFT
  FREIGEGEBEN
  VERSENDET
  ABGESCHLOSSEN
}
